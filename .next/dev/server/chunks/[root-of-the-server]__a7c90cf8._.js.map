{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 112, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/Downloads/sodalicious/lib/db.ts"],"sourcesContent":["import { neon } from \"@neondatabase/serverless\"\r\nimport mysql from \"mysql2/promise\"\r\n\r\nconst connectionString = process.env.DATABASE_URL\r\n\r\nif (!connectionString) {\r\n  throw new Error(\"DATABASE_URL environment variable is not set\")\r\n}\r\n\r\n// Detect connection type: PostgreSQL (Neon) or MySQL (XAMPP)\r\nconst isPostgres = connectionString.startsWith(\"postgresql://\")\r\nconst isMysql = connectionString.startsWith(\"mysql://\")\r\n\r\nlet sql: any\r\n\r\nif (isPostgres) {\r\n  // Use Neon for PostgreSQL\r\n  sql = neon(connectionString)\r\n} else if (isMysql) {\r\n  // Use mysql2 for MySQL/XAMPP\r\n  const pool = mysql.createPool({\r\n    uri: connectionString,\r\n    waitForConnections: true,\r\n    connectionLimit: 10,\r\n    queueLimit: 0,\r\n  })\r\n\r\n  // Create a wrapper for mysql2 that mimics neon's API\r\n  sql = async (strings: TemplateStringsArray, ...values: any[]) => {\r\n    const connection = await pool.getConnection()\r\n    try {\r\n      // Build query from template strings\r\n      let query = strings[0]\r\n      for (let i = 0; i < values.length; i++) {\r\n        query += \"?\" + strings[i + 1]\r\n      }\r\n\r\n      // DEBUG LOGGING\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.log(`[DB] Query: ${query.trim().replace(/\\s+/g, ' ')}`)\r\n        if (values.length > 0) console.log(`[DB] Values:`, values)\r\n      }\r\n\r\n      const [rows] = await connection.query(query, values)\r\n      return rows\r\n    } catch (err) {\r\n      console.error(`[DB ERROR] Query failed:`, err)\r\n      throw err\r\n    } finally {\r\n      connection.release()\r\n    }\r\n  }\r\n} else {\r\n  throw new Error(\r\n    `Unsupported database URL format. Use postgresql:// (Neon) or mysql:// (XAMPP). Got: ${connectionString.split(\"://\")[0]}://`\r\n  )\r\n}\r\n\r\nexport { sql }\r\n\r\n// Type definitions for database operations\r\nexport interface User {\r\n  id: number\r\n  email: string\r\n  name: string\r\n  role: \"cashier\" | \"manager\" | \"inventory_officer\"\r\n  is_active: boolean\r\n  created_at: string\r\n}\r\n\r\nexport interface Product {\r\n  id: number\r\n  name: string\r\n  category: string\r\n  price: number\r\n  description: string\r\n  stock_quantity: number\r\n  reorder_level: number\r\n  is_active: boolean\r\n}\r\n\r\nexport interface Order {\r\n  id: number\r\n  order_number: string\r\n  cashier_id: number\r\n  customer_name: string\r\n  total_amount: number\r\n  payment_method: string\r\n  order_status: string\r\n  created_at: string\r\n  items?: any[]\r\n}\r\n\r\nexport interface OrderItem {\r\n  id: number\r\n  order_id: number\r\n  product_id: number\r\n  quantity: number\r\n  unit_price: number\r\n  subtotal: number\r\n}\r\n\r\nexport interface InventoryLog {\r\n  id: number\r\n  ingredient_id: number\r\n  ingredient_name?: string\r\n  user_id: number\r\n  user_name?: string\r\n  log_type: string\r\n  quantity_changed: number\r\n  reason: string\r\n  previous_quantity: number\r\n  new_quantity: number\r\n  created_at: string\r\n}\r\n\r\nexport interface Ingredient {\r\n  id: number\r\n  name: string\r\n  unit: string\r\n  stock_quantity: number\r\n  reorder_level: number\r\n  cost_per_unit: number\r\n  updated_at: string\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEA,MAAM,mBAAmB,QAAQ,GAAG,CAAC,YAAY;AAEjD,IAAI,CAAC,kBAAkB;IACrB,MAAM,IAAI,MAAM;AAClB;AAEA,6DAA6D;AAC7D,MAAM,aAAa,iBAAiB,UAAU,CAAC;AAC/C,MAAM,UAAU,iBAAiB,UAAU,CAAC;AAE5C,IAAI;AAEJ,IAAI,YAAY;IACd,0BAA0B;IAC1B,MAAM,IAAA,gKAAI,EAAC;AACb,OAAO,IAAI,SAAS;IAClB,6BAA6B;IAC7B,MAAM,OAAO,8IAAK,CAAC,UAAU,CAAC;QAC5B,KAAK;QACL,oBAAoB;QACpB,iBAAiB;QACjB,YAAY;IACd;IAEA,qDAAqD;IACrD,MAAM,OAAO,SAA+B,GAAG;QAC7C,MAAM,aAAa,MAAM,KAAK,aAAa;QAC3C,IAAI;YACF,oCAAoC;YACpC,IAAI,QAAQ,OAAO,CAAC,EAAE;YACtB,IAAK,IAAI,IAAI,GAAG,IAAI,OAAO,MAAM,EAAE,IAAK;gBACtC,SAAS,MAAM,OAAO,CAAC,IAAI,EAAE;YAC/B;YAEA,gBAAgB;YAChB,wCAA4C;gBAC1C,QAAQ,GAAG,CAAC,CAAC,YAAY,EAAE,MAAM,IAAI,GAAG,OAAO,CAAC,QAAQ,MAAM;gBAC9D,IAAI,OAAO,MAAM,GAAG,GAAG,QAAQ,GAAG,CAAC,CAAC,YAAY,CAAC,EAAE;YACrD;YAEA,MAAM,CAAC,KAAK,GAAG,MAAM,WAAW,KAAK,CAAC,OAAO;YAC7C,OAAO;QACT,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,CAAC,wBAAwB,CAAC,EAAE;YAC1C,MAAM;QACR,SAAU;YACR,WAAW,OAAO;QACpB;IACF;AACF,OAAO;IACL,MAAM,IAAI,MACR,CAAC,oFAAoF,EAAE,iBAAiB,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC,GAAG,CAAC;AAEhI","debugId":null}},
    {"offset": {"line": 176, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/Downloads/sodalicious/app/api/orders/route.ts"],"sourcesContent":["import { sql } from \"@/lib/db\"\r\nimport { type NextRequest, NextResponse } from \"next/server\"\r\n\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const searchParams = request.nextUrl.searchParams\r\n    const limit = searchParams.get(\"limit\") || \"50\"\r\n\r\n    const orders = await sql`\r\n      SELECT o.*, u.name as cashier_name FROM orders o \r\n      LEFT JOIN users u ON o.cashier_id = u.id \r\n      ORDER BY o.created_at DESC LIMIT ${Number.parseInt(limit)}\r\n    `\r\n\r\n    // Fetch items for these orders\r\n    if (orders.length > 0) {\r\n      const orderIds = orders.map((o: any) => o.id)\r\n      const items = await sql`\r\n        SELECT oi.*, p.name \r\n        FROM order_items oi\r\n        LEFT JOIN products p ON oi.product_id = p.id\r\n        WHERE oi.order_id IN (${orderIds.join(',')})\r\n      `\r\n\r\n      // Attach items to orders\r\n      for (const order of orders) {\r\n        (order as any).items = items.filter((i: any) => i.order_id === order.id)\r\n      }\r\n    }\r\n\r\n    return NextResponse.json(orders)\r\n  } catch (error) {\r\n    console.error(\"[API] Orders GET error:\", error)\r\n    return NextResponse.json({ error: \"Failed to fetch orders\" }, { status: 500 })\r\n  }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  console.log(\"[Order API] Incoming POST request\")\r\n  try {\r\n    const body = await request.json()\r\n    const { cashier_id, customer_name, total_amount, payment_method, items } = body\r\n    console.log(`[Order API] Processing order with ${items?.length} items`)\r\n\r\n    if (!items || items.length === 0) {\r\n      return NextResponse.json({ error: \"Order must have at least one item\" }, { status: 400 })\r\n    }\r\n\r\n    const orderNumber = `ORD-${Date.now()}`\r\n\r\n    // Create order and decrement stock\r\n    try {\r\n      // Ensure numeric cashierId\r\n      let validCashierId = 1\r\n      if (cashier_id && !isNaN(Number(cashier_id))) {\r\n        validCashierId = Number(cashier_id)\r\n      } else {\r\n        const fallback = await sql`SELECT id FROM users WHERE role = 'cashier' LIMIT 1`\r\n        if (fallback.length > 0) validCashierId = fallback[0].id\r\n      }\r\n\r\n      console.log(`[Order API] Using Cashier ID: ${validCashierId}`)\r\n\r\n      // Create Order\r\n      const orderResult = await sql`\r\n        INSERT INTO orders (order_number, cashier_id, customer_name, total_amount, payment_method, order_status) \r\n        VALUES (${orderNumber}, ${validCashierId}, ${customer_name}, ${total_amount}, ${payment_method}, 'completed')\r\n      `\r\n\r\n      const inserted = await sql`SELECT id FROM orders WHERE order_number = ${orderNumber} LIMIT 1`\r\n      const orderId = inserted[0]?.id || (orderResult as any).insertId\r\n      console.log(`[Order API] Created DB Order ID: ${orderId}`)\r\n\r\n      for (const item of items) {\r\n        const fullName = String(item.name)\r\n        const baseName = fullName.split(\" (\")[0]\r\n        console.log(`[Order API] Mapping item: \"${fullName}\" (Base: \"${baseName}\")`)\r\n\r\n        let products = await sql`SELECT id FROM products WHERE name = ${fullName} LIMIT 1`\r\n        if (!products || products.length === 0) {\r\n          products = await sql`SELECT id FROM products WHERE name = ${baseName} LIMIT 1`\r\n        }\r\n\r\n        if (products && products.length > 0) {\r\n          const dbProductId = products[0].id\r\n          console.log(`[Order API] Found DB Product: ${fullName} (ID: ${dbProductId})`)\r\n\r\n          await sql`\r\n            INSERT INTO order_items (order_id, product_id, quantity, unit_price, subtotal) \r\n            VALUES (${orderId}, ${dbProductId}, ${item.quantity}, ${item.price}, ${item.subtotal || (Number(item.price) * Number(item.quantity))})\r\n          `\r\n\r\n          // Deduct Product Stock in Database\r\n          await sql`\r\n            UPDATE products \r\n            SET stock_quantity = stock_quantity - ${item.quantity}\r\n            WHERE id = ${dbProductId}\r\n          `\r\n          console.log(`[Order API] Deducted ${item.quantity} from product stock (ID: ${dbProductId})`)\r\n\r\n          // Ingredient Deduction Logic\r\n          const recipes = await sql`\r\n            SELECT pi.ingredient_id, pi.amount, i.stock_quantity, i.name as ing_name\r\n            FROM product_ingredients pi\r\n            JOIN ingredients i ON pi.ingredient_id = i.id\r\n            WHERE pi.product_id = ${dbProductId}\r\n          `\r\n\r\n          console.log(`[Order API] Found ${recipes.length} ingredients for ${baseName}`)\r\n\r\n          for (const recipe of recipes) {\r\n            const deduction = Number(recipe.amount) * Number(item.quantity)\r\n            const prevStock = Number(recipe.stock_quantity)\r\n            const newStock = prevStock - deduction\r\n\r\n            console.log(`[Order API] Deducting ${deduction} from ${recipe.ing_name}. Prev: ${prevStock}, New: ${newStock}`)\r\n\r\n            await sql`UPDATE ingredients SET stock_quantity = ${newStock} WHERE id = ${recipe.ingredient_id}`\r\n\r\n            await sql`\r\n              INSERT INTO inventory_logs (ingredient_id, user_id, log_type, quantity_changed, reason)\r\n              VALUES (${recipe.ingredient_id}, ${validCashierId}, 'sale', ${-deduction}, ${`Order ${orderNumber}`})\r\n            `\r\n          }\r\n        } else {\r\n          console.warn(`[Order API] ⚠️ Could not find product in DB: ${baseName}`)\r\n        }\r\n      }\r\n\r\n      console.log(`[Order API] ✓ Order ${orderNumber} fully processed and synced.`)\r\n\r\n      return NextResponse.json({\r\n        id: orderId,\r\n        order_number: orderNumber,\r\n        customer_name,\r\n        total_amount,\r\n        payment_method,\r\n        order_status: \"completed\",\r\n        created_at: new Date().toISOString()\r\n      }, { status: 201 })\r\n\r\n    } catch (dbError: any) {\r\n      console.error(\"[Order API] ❌ Database synchronization failed:\", dbError)\r\n      return NextResponse.json({\r\n        order_number: orderNumber,\r\n        order_status: \"partial\",\r\n        warning: `Database sync failed: ${dbError.message || dbError}`,\r\n        created_at: new Date().toISOString()\r\n      }, { status: 201 })\r\n    }\r\n  } catch (error) {\r\n    console.error(\"[Order API] ❌ Critical Error:\", error)\r\n    return NextResponse.json({ error: \"Failed to process order\" }, { status: 500 })\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}